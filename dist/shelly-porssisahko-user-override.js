let C_HIST=24,C_ERRC=3,C_ERRD=120,C_DEF={mode:0,m0:{cmd:0},m1:{lim:0},m2:{per:24,cnt:0,lim:-999,sq:0,m:999},vat:24,day:0,night:0,bk:0,err:0,outs:[0],fh:0,inv:0},l={s:{v:"2.9.0",dn:"",st:0,cmd:0,chkTs:0,errCnt:0,errTs:0,upTs:0,timeOK:0,configOK:0,fCmdTs:0,tz:"+02:00",p:{ts:0,now:0,low:0,high:0,avg:0}},p:[],h:[],c:C_DEF},c=!1,o=!1;function i(t,e){e-=t;return 0<=e&&e<3600}function f(t){return Math.floor((t?t.getTime():Date.now())/1e3)}function n(t,e,s){let n=t.toString();for(;n.length<e;)n=s?s+n:" "+n;return n}function u(t){return t.getDate()}function r(t){let e=t.toString();(e="+0000"==(e=e.substring(3+e.indexOf("GMT")))?"Z":e.substring(0,3)+":"+e.substring(3))!=l.s.tz&&(l.s.p.ts=0),l.s.tz=e}function a(t,e){console.log((new Date).toISOString().substring(11)+": "+(e?e+" - ":""),t)}function b(){var t=new Date;l.s.timeOK=2e3<t.getFullYear()?1:0,l.s.dn=Shelly.getComponentConfig("sys").device.name,!l.s.upTs&&l.s.timeOK&&(l.s.upTs=f(t))}function p(t){Shelly.call("KVS.Get",{key:"porssi-config"},function(e,t,s,n){l.c=e?e.value:{},"function"==typeof USER_CONFIG&&(l.c=USER_CONFIG(l.c));{e=function(t){l.s.configOK=t?1:0,l.s.chkTs=0,n&&(c=!1,g())};let t=0;if(C_DEF){for(var r in C_DEF)if(void 0===l.c[r])l.c[r]=C_DEF[r],t++;else if("object"==typeof C_DEF[r])for(var o in C_DEF[r])void 0===l.c[r][o]&&(l.c[r][o]=C_DEF[r][o],t++);void 0!==l.c.out&&(l.c.outs=[l.c.out],l.c.out=void 0),C_DEF=null,0<t?Shelly.call("KVS.Set",{key:"porssi-config",value:l.c},function(t,e,s,n){n&&n(0===e)},e):e&&e(!0)}else e&&e(!0)}},t)}function g(){if(!c)if(c=!0,b(),l.s.configOK)if(function(){let t=new Date,e=!1;e=l.s.timeOK&&(0===l.s.p.ts||u(new Date(1e3*l.s.p.ts))!==u(t)),l.s.errCnt>=C_ERRC&&f(t)-l.s.errTs<C_ERRD?(C_ERRD,f(t),l.s.errTs,e=!1):l.s.errCnt>=C_ERRC&&(l.s.errCnt=0);return e}()){let e=new Date;r(e);try{let t=e.getFullYear()+"-"+n(1+e.getMonth(),2,"0")+"-"+n(u(e),2,"0")+"T00:00:00"+l.s.tz.replace("+","%2b");var s=t.replace("T00:00:00","T23:59:59");let c={url:"https://dashboard.elering.ee/api/nps/price/csv?fields=fi&start="+t+"&end="+s,timeout:5,ssl_ca:"*"};e=null,t=null,Shelly.call("HTTP.GET",c,function(e,t,s){c=null;try{if(0!==t||null==e||200!==e.code||!e.body_b64)throw Error("conn.err ("+s+") "+JSON.stringify(e));{e.headers=null,s=e.message=null,l.p=[],l.s.p.high=-999,l.s.p.low=999,e.body_b64=atob(e.body_b64),e.body_b64=e.body_b64.substring(1+e.body_b64.indexOf("\n"));let t=0;for(;0<=t;){e.body_b64=e.body_b64.substring(t);var n=[t=0,0];if(0===(t=1+e.body_b64.indexOf('"',t)))break;n[0]=+e.body_b64.substring(t,e.body_b64.indexOf('"',t)),t=2+e.body_b64.indexOf('"',t),t=2+e.body_b64.indexOf(';"',t),n[1]=+(""+e.body_b64.substring(t,e.body_b64.indexOf('"',t)).replace(",",".")),n[1]=n[1]/10*(100+(0<n[1]?l.c.vat:0))/100;var r=new Date(1e3*n[0]).getHours();n[1]+=7<=r&&r<22?l.c.day:l.c.night,l.p.push(n),l.s.p.avg+=n[1],n[1]>l.s.p.high&&(l.s.p.high=n[1]),n[1]<l.s.p.low&&(l.s.p.low=n[1]),t=e.body_b64.indexOf("\n",t)}e=null,l.s.p.avg=0<l.p.length?l.s.p.avg/l.p.length:0;var o=new Date,i=new Date(1e3*l.p[0][0]);if(u(i)!==u(o))throw Error("date err "+o.toString()+" - "+i.toString());l.s.p.ts=f(o),l.s.p.now=y()}}catch(t){l.s.errCnt+=1,l.s.errTs=f(),l.s.p.ts=0,l.p=[],a(t)}m()})}catch(t){a(t),m()}}else!function(){if(0==l.s.chkTs)return 1;var t=new Date,e=new Date(1e3*l.s.chkTs);return e.getHours()!=t.getHours()||e.getFullYear()!=t.getFullYear()||0<l.s.fCmdTs&&l.s.fCmdTs-f(t)<0}()?c=!1:m();else p(!0)}function A(e){l.c.inv&&(o=!o);let s=0,n=0;for(let t=0;t<l.c.outs.length;t++)!function(r,t){var e="{id:"+r+",on:"+(o?"true":"false")+"}";Shelly.call("Switch.Set",e,function(t,e,s,n){0!=e&&a("error setting output "+r+" "+(o?"ON":"OFF")+": "+e+" - "+s),n(0==e)},t)}(l.c.outs[t],function(t){if(s++,t&&n++,s==l.c.outs.length)if(n==s){for(;l.h.length>=C_HIST;)l.h.splice(0,1);l.h.push([f(),o?1:0]),l.s.cmd=o?1:0,e(!0)}else e(!1)})}function m(){var t,e,s=new Date;r(s),o=!1;try{function n(t){o!=t&&(l.s.st=12,a("Note: command edited by user script")),o=t,A(function(t){t&&(l.s.chkTs=f()),c=!1})}0===l.c.mode?(o=1===l.c.m0.cmd,l.s.st=1):l.s.timeOK&&0<l.s.p.ts&&u(new Date(1e3*l.s.p.ts))===u(s)?(l.s.p.now=y(),1===l.c.mode?(o=l.s.p.now<=("avg"==l.c.m1.lim?l.s.p.avg:l.c.m1.lim),l.s.st=o?2:3):2===l.c.mode&&(o=function(){if(0!=l.c.m2.cn){var n=[];for(d=0;d<l.p.length;d+=l.c.m2.per){var r=[];for(ind=d;ind<d+l.c.m2.per&&!(ind>l.p.length-1);ind++)r.push(ind);if(l.c.m2.sq){let e=999,s=0;for(h=0;h<=r.length-l.c.m2.cnt;h++){let t=0;for(v=h;v<h+l.c.m2.cnt;v++)t+=l.p[r[v]][1];t/l.c.m2.cnt<e&&(e=t/l.c.m2.cnt,s=h)}for(h=s;h<s+l.c.m2.cnt;h++)n.push(r[h])}else{for(h=1;h<r.length;h++){var t=r[h];for(v=h-1;0<=v&&l.p[t][1]<l.p[r[v]][1];v--)r[v+1]=r[v];r[v+1]=t}for(h=0;h<l.c.m2.cnt;h++)n.push(r[h])}}var s=f();let e=!1;for(let t=0;t<n.length;t++)if(i(l.p[n[t]][0],s)){e=!0;break}return d=null,h=null,v=null,e}}(),l.s.st=o?5:4,!o&&l.s.p.now<=("avg"==l.c.m2.lim?l.s.p.avg:l.c.m2.lim)&&(o=!0,l.s.st=6),o)&&l.s.p.now>("avg"==l.c.m2.m?l.s.p.avg:l.c.m2.m)&&(o=!1,l.s.st=11)):l.s.timeOK?(l.s.st=7,t=1<<s.getHours(),(l.c.bk&t)==t&&(o=!0)):(o=1===l.c.err,l.s.st=8),l.s.timeOK&&(0<l.c.fh&&(e=1<<s.getHours(),(l.c.fh&e)==e)&&(o=!0,l.s.st=10),0<l.s.fCmdTs)&&(0<l.s.fCmdTs-f(s)?(o=!0,l.s.st=9):l.s.fCmdTs=0),"function"==typeof USER_OVERRIDE?USER_OVERRIDE(o,l,n):n(o)}catch(t){a(t),c=!1}}let d=0,h=0,v=0;function y(){var e=f();for(let t=0;t<l.p.length;t++)if(i(l.p[t][0],e))return l.p[t][1];throw l.p.length<24&&(l.s.p.ts=0),Error("no price for this hour")}a("shelly-porssisahko v."+l.s.v),a("URL: http://"+(Shelly.getComponentStatus("wifi").sta_ip??"192.168.33.1")+"/script/"+Shelly.getCurrentScriptId()),HTTPServer.registerEndpoint("",function(s,n){try{if(c)return s=null,n.code=503,void n.send();var r=function(t){var e={},s=t.split("&");for(let t=0;t<s.length;t++){var n=s[t].split("=");e[n[0]]=n[1]}return e}(s.query);s=null;let t="application/json",e=(n.code=200,!0);var o="text/html",i="text/javascript";"s"===r.r?(b(),n.body=JSON.stringify(l),e=!1):"r"===r.r?(p(l.s.configOK=!1),l.s.p.ts=0,n.code=204,e=!1):"f"===r.r&&r.ts?(l.s.fCmdTs=+(""+r.ts),l.s.chkTs=0,n.code=204,e=!1):r.r?"s.js"===r.r?(n.body=atob("H4sIAAAAAAAACo1W4W7bNhB+FYXrAhJmCKft/thTjbbJ1nVJM9RegaEoFkaiI9o06ZAnt4art8mb5MV2lGRHCdx2f+KY/O7uu7vvjjYKkr/fn6WEcPwYx8+bkEL6IndZuVAWxE2p/HqsjMrAeQqMn7z6PaUsfbGp+HjycnL673jyPv1I/ry7XVurAyi4u727tYTHo6BdMZNlwG9vtAWZSGNU4uVM2t3R2uhHJ0onhTQrvVhqmaA7Y+5uk4iYyXlwxsgd8n/C6qhSW5ksI7kaeLSN+UH6RVkGKC20bBMaGaClm0mOdnN0r1XuQpAs+ry7xWigjdzCawjadFF/yfncHW0RP4dEBtAPLwDKpA77oBYLZK8XeksvFhYw3gyLmoS518sdTUTPtZ85DSAl+cTPL0467Xhc++gQ/38bi2Pbyi0kRAZWA5oHkKDSldN50uevX43Tj5/4QtXNRl24pbITeZXKsLZZghLZNMiDNIXDQ0Li59evFFIC8uoo+sLQjH/WNnefhXGZRN5WFDIUKQxX0icyvQmU/ER6wIby8JBKkRUqm6s8PegzTkiaNoDsKEKEtlb5N5Pzs8ND+VlqSJZuWRqkfLK2cqGzEwmSQo+IAhYGE23tKq5W0rx2WAGNDsZZrOBEXoeUttycNU7mTWK1sttU6T7uIpRXAby21/S4txeAZ+rLxTRmxhiG3z9KL42hRACWSEydP5VZgaV7AULm+ekK0WdxlJAvJVkh7bUiHDrMQGA/rxUInbOKMY5OY4g/csSgOxrLG+pMQ6zh7prtIdHgsFU67Q/1r62ZMMpeQzHUvR5rjz7qT00TJuoLjGJV6b4bNpgqwHQ6d8FnTEChLJ2WNoulojl2i23iXwFoRB/fe7apI3jMr2K842wpPebyzuVKeLVwK/W60CbvhIv4PdpoGwxcxh6DX29OTj/Uio2rr0dGPkW9oM+lkZmitYxRRtig3dFWWtjYWsEqbZSInWjUxw+O2VAJNx9RLLvsiDZVIib7LTEilg0em5BT752P3gH1lkT7QUJ6SsAXqFByUTNskzmL204JFcF4UFW85dNmjEHjRLVJR9665d00SrKhnlKNrNnG4IMAqS2NGXoFpbfJ0/5zHG0tmonGMYVUjRpzLWa4SigbbL82nUQltWi+cfPBQZ9n2KzB7hDZ775EwfA6MaiqNuLDhGSPxKS7Bqzxe7zH7+WTjawGyZNNF18lFI8fcKzYZRM2plrdF3MvhdYpOnk7vngnmvHX03UsNrt8yObouMvjGybd0BXHgcU9fBKXL844WoJoGqjiVLhxs20YCj8f49gDfcpJn7BKPNlQQnq4h2qDc1RVgdXfA7xsEL9hwH+U9JS1MSc67necCNRHFMkxiysIkW9c6cN3o2NXSBtX2xLUD9BUjnYGY4Xlzb9vMCDRSI2I2EUxRofvWj7bWXZKui/F+1tsR4+guu7LEaFcMV4usUfqzLll52Gon6Ow1BaXQoA1CmSlg77SRsM6JfX/RpHhdszg0XrY7Rnc+kOIW6J5cqFeDYNf+s/iIyqijnDOmrsoEhZf4wfPBLb52wuA31tWU/zRY8z6B8wLnecKf2wEVdfAlUDv8+fH6jkulSFuy5FXN2/RU65WOPpY63sUZcP/ABwXa3JNCgAA"),t=i):"s.css"===r.r?(n.body=atob("H4sIAAAAAAAACo1VS2/jNhD+K8QGBZJsJEvJOnUktGhPCxRF0Ut7KXqgyKHEmiIFkvJjA//3Dqmns1m0F1ucF795fMPN/T25J64Bpc5JZ6xz0tFmb0gQ37I78kuPIiKd8VQZkpDG+67YbP4ZJamQaBiEDqW19E1fpcy0s8HmG7F/lQy0g4J8/u0P8rMQYA35DBosVeT3vlKSTSbk8JRm5H6DTq+kMqfEyS9S1wV+Ww42QVFJLnji5wdC0YYZZWxBboCJTOSTLjhTtq+t6TVH7SN7gm1WEiU1JA3IuvEFydNP0JZEGO3DNQgvS19miaCtVOeC/AmWU01L0tJTcpTcNwX59GKD3XjKs+y7oLa11BiD0N6bknSU84h8253QpIu4b7z0ChDd6tIRxuCPCXpv2ugVHZjpztf2WboL9lTJWicOlCiIUHBKQPOSeDj5JKoKYkOaIUgq1AljcOk6Rc+DeZR7WjlUdMZJL01wAUW9PEB5Xb6cVuyFzS5FUYEwFh6mIxUebGyG9qCxtB8+lMt1aKNg5TxbK6A2dNY3kzZkqgzFCArEgN27NXRt9BwqUbQCtdZWyrD9my4/pt9vQ73mfmRY8ec81nAcKjtaYqOcUZJjws80221Lwnrrwnh1RmJmdr55TBTvvpqBpZCYqFG9R6xfEqk5nNAEu2O6BVDIENGskOVxqq4qL4Qo5xmfpth0lEl/js6xQgVrgO2Bf7wqy38HGvIvvgoTI3x8k+l8a75K6nFwNd26DbWVOIrhN/HQoswDxlF9qx16CxsZEj6is+t0nMFY4QQOeJubGj1VN32MpVmYO5xH/EiJcB6b5y3VrqMW48wdnhKfBnkUI+5JdWxk6NY0EZTLHlFsQ1epli0d2hqw5i4OGLVEaiF1dLuQn/ZwFpa24MiQUJgI/ItokCxIaYs70sPt03PGob5Dn8tAjZQx4nkhpHU+YY1UHIlV1RPrj2PSlVFY1QNYLxlVE8kxhW+TFXmftCY0UUVm4Zbg0gIbyW6OEXkLXNLb9Xrb4bq6C+AjvBbRvcOyq8m/rGzXmbxOe22c9rDVluLHCZ43+7D4sqtgdh0sPgmLb458rRSmPjT+f2Q8DOFbwx+5PJDXZYGXS2uWG12Y/rg+1kOlaBeetenr66IsmN/Bu34iBh6xUPTVCsc3cVo7Qq7XDUaPExtxQaDL0dIuGh7zXbay3I1PT9r6PJvTHCs46bAa+VivyO9gbrfroswYW7XIx65OqurhxiWs5e9P7gX50vX+L3/u4Ieqx27rv9++hHlg9eVfkoq6D6gIAAA="),t="text/css"):"status"===r.r?(n.body=atob("H4sIAAAAAAAACqVSS07DMBS8iuUVLJo2CyQWqSV2CFUqElzgxXbJax07xK8tuU/OwAVyMZxPU6UtbFjYi5nxvJmXJASp0Uwa8H7JcyYlFwmV4agBPMaPC7HOtrD3zFbUEqiWfiZzJVaggABsFEXDo16589oyrw2SHvWeTsbiramzXfNtWYaWYOJq3fFSxqipbVOHa1QpqMRkoKeqKgocBblTelSsAIl0SGQxP0uUHQXvaGDE0W6cSObdXkSi8HBazsZ8sXCCdzqTzvAJSbLlYpaXD1dETvEigKl4bWo8hB5tbwvEtsBclz6Zp2FkeBXi9HMnn4ATSz+4eMIdXIHP7Qqv0PVg29mkTlV9t+JcrJ92q4H5o0Hvm6EnVyL8I/YvAVvny4znpJ3kRq5e4WWJBYlSf774Ox4swi8HtPfR1vP7ZD7QP8yL/z3xAgAA"),t=o):"status.js"===r.r?(n.body=atob("H4sIAAAAAAAACoVW627bNhR+FZntDHKSFTsbBiQSbWy9oENbpFgMbIBhzKxER6xlUhVpZ4Gtf3mUPENfwC+2Q11sy3M6xLHJw3P5zuHHQ25SbpyM9r0x/Ee0H6xZ7nDK9IOMMKHDjckfNmKO10rETr9DqTbMcGJFnWpoklzdO2/yXOUYSeXEzDBESj95pe0JmvvaY/AdeYb2w9zP/JTLO5N4iuJYRasll8Y3wqSczl5uhB/Lkf1ykdNz0DVCxafdt1xroXdPyWL3beZ91Ri90L1oGSPiCyl5/m788QMVPkhG6NPucff44cPuEWw/3fx+i9r62jyk3I9UqvLG4i7nXIJ2zuO98lLFvOX9483rN3/fjv+YMN+uTRvFWJ6AiOV2i0IxfCMcprnhxqzCCzHce5bqvmVhINvMB6lv1FvxD4/xJYHco4vFn4lNv7HTpmWGryiFaNqMbse/jitodjr1c56lLOIY/aCRN1f5kpnXsBNjseRY8nvHTvCA//Sj8OevlvFYE68zIOT6xA9xMYN46xFy8GL3tHuShgvJJbGgyD599nCSzew91wvB8rW6dux2Zj5b3x3lVlSphZ/z4TuWroVs1NJWCY7U3rM05Qe9RNwl/1WcHZVKyLlqoZrdJF/YSjuG5Quhyz0BZ1VtztUlShZQFnDdc2Yu7oc2rNEjlIBLZpyElR6Q+7wHqw81tRZwDAQ36gsr7RiTvu8fCrhuA32/e3qQssL4sMf43P6tsgqm3aDSDM4IGGG8VyT+Ha8Akt4548MyuQDxxS99+7n8mewrjAYIImS7J7G2LCBQkzXPtVBQGuGvvcmUBNARLoGO1dHodg0B2Nh2FzjxgTk684Fxrdaln/GcbGyfWNLJNGjUOTUBD43bqHS7HcyHB/PegATcdcnSz1Y6wbyMXCrrr2RTebi6uvIkhG18ahjrkC4bF6V6JE2gwdGmAXlAoAGBdvdaNhyABgyT5YRPp5PBNDAXzXII2WJAvRdAaE2KgzcJ3mTbm6rAW2+k4KnmZ0AMwKxBXBqVtdLUGpVqhvLeIOiH1HS7Fpu2wMIKpalR9noEJu5gSq0sqMf6CF0fwjyPrYDigvusYxuNJfR2O4Zxm1vv1CrXwJ5NzeesxWeEgnoPoDCdQfAdXtQ5xmWpzdRLaYuv8aQPRKthH3ENfvu2jW+3gyNpbKtBMYLWg0rpwE/FclR3o+tGQLbbY94qQB6lq5hrbMgZJ5d+ywVMTxycsTgJe1mHBdbOk+4gDA2h1P4EZbMt2dThxDNDqo+OAdaHc2MrKatLNqGz0AAv7J1G0ctNerQjz2zUCM2VNL17Dl3UXH9WaRyUl+zLjRyhzyxa3OVqJePrFzy2f9UiGs68hGL7cW3I2IlSpjVFc2HQsNVJU3uZFOGFiYcz4lpdWLd1OdPb20p8hP4qo1VyF8FvPkTBOWK5NCmympXwfDmbqaVv7ifAp8TXKjcYcw+qPTTApB63dPLscySpKdjtRkBumMOKXWwInYiTmxc4bWlcPpYcNXfApKKupCi0iGGDsPy/OrXIXaE5UzgOhRuh+vbKbP+FqxCK1EiU0M/V6xS3S2URHfIriiJiJrJNdBMpqRW8inj5kIOuCt2FDsEPP8n7mZcXGouUOVw4cNHFSmv2nTdX9coy+7dTPSxfRfW4envVk2w/qm71emJzK4oA7i3v1W+3zXVQ/AtvzOYX0woAAA=="),t=i):"config"===r.r?(n.body=atob("H4sIAAAAAAAACp1U3W6bMBR+FQtpantBk9CorSZiiYtWIW2gWminXRrjFgdjUzDpsus9Sp6hL8CLzfwmsLVVJ8EFx+c73/H5voMZ0A3ADGXZTJMY+Br8cXtlr648c6ROoCmRz0ibEAOMNRVL1Rs0wZfJ5Ri64RrlmUQJUgfQzAgjWAIazGIREGiO6kCLrNKlRBskASt2YVC8ygpHeZJXMJHLDGT0F5lNO9BNsSt2XBLKCQeiIjwAyW1CZjgkOPLFz7IE5ZsOulIkUfHKgXX70CcqW6h4DAi+dOmUplLEKMryqq/xhW4YX8EeFaBth8Kj6Hto7qcYy8kYGoY+vjhEcPoUygGmGXDN+YDSOFcjzDmnJWkJ8qPueF7spHooQx/fnKQpBCZDPmHgUaTVt+uM3Otrc1RFu6p3KIqEXlWMMtLSPoZKsUp3aPbdUd6ttMhN8Xtlu/OFdb/6D5u813s81nEc9NpvQoMbvN/g3HY865u1sD7V3pxyiVK0Rn2PxBOd0Xgo3rv8C+tm5TpgrvxmL5eWB7x7x7E/t1PWGvG18qAYrpShJ0Rli0RSwcEGsVz1NYXGtB+aGHBi9EOX8LIfOIfn/cAUDqqcwbMBEzS6fQZh6yQv55LG5YamxW4wPkPHfO/9DnJHVGoUFTtaW+9tTxh69tx51qIcgaRkYurfAfSBXjVNA1OytXo16KUaKI1pWCr9Fir+WGPt4H4Z2pC6aT+XspuThxgjnCPYiP5vo3iuvbQdx/X+ypK45dj/V3o05aaKFJOG72CXM2j66QdowTGjOJodvVAeiJdTkRB+rI20k6O63CokjG3b5jOc0kTClDwvsmNNjUXHgj/Sp9N1pp0oO9THfwCHFnhyTAYAAA=="),t=o):"config.js"===r.r?(n.body=atob("H4sIAAAAAAAACoVVbXPaOBD+K0aXoVZxFON2+gEQzN2lMzfX5DJTcp1+O4RZgw75JbagZTj+Tf5J/lhXkiF2wly/GHb30Wq1+zzSXoH2FO/0h1tResBFtctin/LxXpe7vUz8bS4XXtjhvNJCQ7fbUd2u/Uv3ZoV2fhYPHyqf/JLmCyCUySyD8o/72xt+e3f98Z/p/WeWisL3IRCYejbKCy3zzNsKtQFOLvbiQMYXeziMrlxkPKNBM58DamZMF8g3umoEjMn+zWXmk4DUa2W2RUS8gngNC8SgPSG1SQaEONRW6EYetJx7IXYNN1rOncnlqom39tD0UHBChkle+sYAHg5hFL0fQq9HRY/PRjIrNtrTuwLPa2uY59+JJxecfDUHJ+OREnNQHmY4uS72PiE9oKwQi6kWpfajgISEYpsseOzNXNfn61bPBSuhUCKGX5XyyVfsyPzYk2T1E2RC6PlTuI1sOceW+prN193+aASUc/NT7/ESlKyaIFcylGVrOGifGU4aXsbpogVMQ4auc9j+pZJpkyx9ho46GF0WUDaDEUPHKRhnuh1ExylYPbQriFj1cK6A6DJtJ3ne/EVlka0MZRceDrHQ8cpHOcV5VuUKTCtwAEAPhyH4NPj9tykrNpWBuHSV2BpNiMXi4xYyfSMrDThQn8RKxmsSWAnj8MZ7YEUJBnMNidgo7dOhUXVbt468CO85ttmLIDYOIrZLwjluCnXtE+saCL/hw5xWl9x625KlgZMmf6VZVhVKaqtWezXgdgJTmgWoU/5awJP+IAysQI8bNZRrlqFGj5GGeE3EivQYaynYROdrpPkz5Q1d/5/33a4lPjef/yyxz/DegjCT+TjQ0JKcv2Z/fTJHbH6W90eIZTSPG2wPjlQ+tb/F9DqObOa3Qq9YijfkifzPKxr0p/WS6oGf4/+xkui5kqhZycmHHsukiotvQmpvCfpaaOH//fmm9+aqLOKrT1+mbAp6soYdJ0VeVpW8RA0kckm6Tilven9O7/5ilS5ltpTJzteUDqMwxMeIxUizSSPptEcmJTcH1yvIDJ/2QgHemeReKAV45Wm96WCZ5rE74Hmc7E6w2RdZrmDgmauXzuiBDl76K6a/axs7SbbeoYbg/FkKVSWWRrxHVuRl/HO52hfXvcBFmaeFKXuTaZk+PT49lk+PA+xmtlEK32F8g7HscISfWrF0YmebqBxZfG1UneXffHrVh3e9D+FbePshpDg1eD0J17Skiwo1iQJ3nih8j9u4DpO7Tx284honxCZQbM/hB4YxHKg6CAAA"),t=i):n.code=404:(n.body=atob("H4sIAAAAAAAACo1SzY7TMBB+FeMDakWTihvajb1CsAf2xAFxRa49bWbr2sYzaVUh3oZn2Bfoi+E02Z8srODieOYbf983k2leuWj5mKDlnddNfwpvwkZB0M0O2AjbmkzAquN19U43jOxBfz7dZSKk0692e7prlkN2eBDMDtQe4ZBiZmFjYAis5AEdt8rBHi1U52CBARmNr8gaD+qt1I3DvbDeECmOaQjRqb9rFvChghKG8SGl4nwC2piO+nV/XoqbrlCITxTZ+ChmjRFthrVqmRNdLJe3OCD1GgWbvCl9f1uVeWz1E6RZGj0fJR6FRttmRc9i3WBIHYt+yiobh3EYkTm3ZlYVseGOyqDBbqHYHb73BKRF480KvFjHPKm/F6jOsP6C3jTL4T51UI0/4TyM6pFCv9zEP00XyjVuXjY5xR9Mvi+r1G3L8b9OB56p0+EkmzGxLgXE4uP1V3XA4OKh9tEaxhjqmHGDocZgfeeAZrJHfBuJ5fzSAwunyvJ3u6K3sBkMw7WHPlKgtKsnqRnMFyYlCO5Di94NFavojvWTbF+U4fsN9fCPvcmC1JRFDqaLPtWUrSq2r+BCXmUl30CdIXljYSb7xuVCyonmjOY/F5b+oPQYtoWwIIXAK0l89EAtAMu+vD4veC8kqS6xPMsN1wl9SYz2i836lmTZ8XHGvwHYLtlMJgQAAA=="),t=o),n.headers=[["Content-Type",t]],e&&n.headers.push(["Content-Encoding","gzip"])}catch(t){a(t),n.code=500}n.send()}),Timer.set(1e4,!0,g),g();

function USER_OVERRIDE(cmd, state, callback) {
  try {
    console.log("Suoritetaan USER_OVERRIDE. Ohjauksen tila ennen: ", cmd);

    let temp = Shelly.getComponentStatus("temperature:100");

    if (!temp) {
      throw new Error("Kyseistä lämpötila-anturia ei löytynyt");
    }

    if (cmd && temp.tC > 15) {
      console.log("Lämpötila on yli 15 astetta, asetetaan ohjaus pois. Lämpötila nyt:", temp.tC);
      cmd = false;

    } else if (!cmd && temp.tC < 5) {
      console.log("Lämpötila on alle 5 astetta, asetetaan ohjaus päälle. Lämpötila nyt:", temp.tC);
      cmd = true;
    }
    
    console.log("USER_OVERRIDE suoritettu. Ohjauksen tila nyt: ", cmd);
    callback(cmd);

  } catch (err) {
    console.log("Virhe tapahtui USER_OVERRIDE-funktiossa. Virhe:", err);
    callback(cmd);
  }
}